---
title: "Serverless Deployment for ML Model Inference"
subtitle: "AWS Lambda with HTTP API"
author:
- name: Kyle Chung
  affiliation:
date: "`r format(Sys.time(), '%d %b %Y')` Last Updated (05 June 2021 First Uploaded)"
output:
  html_notebook:
    highlight: zenburn
    number_sections: yes
    theme: lumen
    toc: yes
    toc_depth: 3
    toc_float: yes
    includes:
      in_header: /tmp/meta_header.html
  code_download: true
---

```{r meta, include=FALSE}
library(metathis)

# Add open graph meta.
meta() %>%
  meta_description(
    "A data science notebook about serverless deployment for AWS Lambda with HTTP API."
  ) %>%
  meta_viewport() %>%
  meta_social(
    title="Serverless Deployment: AWS Lambda with HTTP API",
    url="https://everdark.github.io/k9/notebooks/data_eng/serverless/lambda_http_api.nb.html",
    image="https://everdark.github.io/k9/assets/avatar.jpg",
    og_type="article",
    og_author="Kyle Chung",
    twitter_card_type="summary"
  )

contents <- c()

# Add Github corner.
github_corner_svg <- "../../../assets/github_corner.html"
github_corner_conf <- list(github_link="https://github.com/everdark/k9/tree/master/notebooks/data_eng/serverless")
contents <- c(contents, stringr::str_interp(readLines(github_corner_svg), github_corner_conf))

meta_header_file <- file("/tmp/meta_header.html")
writeLines(contents, meta_header_file)
close(meta_header_file)
```

# Context

We provide a minimum step-by-step working example using the [Serverless Framework](https://github.com/serverless/serverless) to deploy a machine learning model predictor with [AWS Lambda](https://aws.amazon.com/lambda/?trkCampaign=acq_paid_search_brand&sc_channel=ps&sc_campaign=acquisition_SG&sc_publisher=Google&sc_category=Cloud%20Computing&sc_country=SG&sc_geo=APAC&sc_outcome=acq&sc_detail=%2Bamazon%20%2Bcloud%20%2Bservices&sc_content={adgroup}&sc_matchtype=b&sc_segment=476994412013&sc_medium=ACQ-P|PS-GO|Brand|Desktop|SU|Cloud%20Computing|Solution|SG|EN|Sitelink&s_kwcid=AL!4422!3!476994412013!b!!g!!%2Bamazon%20%2Bcloud%20%2Bservices&ef_id=Cj0KCQjw5PGFBhC2ARIsAIFIMNcyOLXdV8ZGN9mTRieTG8HLRNcAoIE3jkWHWr95FnXq_g6V4pw6VAAaAhcxEALw_wcB:G:s&s_kwcid=AL!4422!3!476994412013!b!!g!!%2Bamazon%20%2Bcloud%20%2Bservices) and [API Gateway](https://aws.amazon.com/api-gateway/).

# Problem Statement

TBC.

# Prerequisite

[`Node`](https://nodejs.org/en/) is required.
We recommend to use [`nvm`](https://github.com/nvm-sh/nvm) to manage `node`.

Once `node` is ready on our system try to install `serverless`:

```bash
npm install -g serverless
```

We also need [Docker](https://www.docker.com/) in order to build the image for packaging.

Also, apparently, we need an AWS account. :)

# Workflow

## Create Project Template

Run

```bash
serverless create --template aws-python3 --name lambda_http_api --path lambda_http_api
```

which on success will give the following message:

```
Serverless: Generating boilerplate...
Serverless: Generating boilerplate in "/Users/kyle.c/k9/notebooks/data_eng/serverless/lambda_http_api"
 _______                             __
|   _   .-----.----.--.--.-----.----|  .-----.-----.-----.
|   |___|  -__|   _|  |  |  -__|   _|  |  -__|__ --|__ --|
|____   |_____|__|  \___/|_____|__| |__|_____|_____|_____|
|   |   |             The Serverless Application Framework
|       |                           serverless.com, v2.44.0
 -------'

Serverless: Successfully generated boilerplate for template: "aws-python3"
```

This will create two important files:

- A templated Python script as the Lambda entry point
- A templated `serverless.yml` to configure our deployment

## Serverless Configuration

Let's edit the `serverless.yml` to be something like the following:

```yml
service: predict

frameworkVersion: '2'

provider:
  name: aws
  region: ap-southeast-1
  runtime: python3.8
  lambdaHashingVersion: 20201221

functions:
  predict:
    handler: handler.predict
    events:
      - httpApi:
          path: /predict
          method: post
    package:
      patterns:
        - model.joblib

plugins:
  - serverless-python-requirements

custom:
  pythonRequirements:
    dockerizePip: non-linux
```

Several important notes:

- the `events: httpApi:` defines our Lambda function to be exposed to an HTTP API endpoint
- the `package:` section will include/exclude any file that is dependent by the functions
- the `plugins:` section specify additional `npm` packages that will help us package the service
- the `custom: pythonRequirements: dockerizePip: non-linux` specifies that we want to prepare dependencies using Docker only when we are on a non-linux host OS

We can also set `dockerizePip: true` to always use Docker for dependency preparation.
Be aware that our final deployment of Lambda will still have package type to be `Zip` instead of `Image`.
Here `dockerizePip` simply means that we want to prepare the dependency using a Linux environment even if we are not on a Linux machine.
This makes sense since the Lambda is going to be running on a Linux machine that is basically different from our local environment.
By default `serverless` will use a Docker image that is as close as the Lambda running environment,
if not entirely identical.^[https://github.com/lambci/docker-lambda]

### ML Model Dependency

Ideally, model file should be loaded from a versioned repository (such as AWS S3).
But in this example just to demonstrate the file dependency layer and also for simplicity,
we put a static model file and use `package:` section to include it.

### Python Package Dependency

The Python environment running AWS Lambda by default comes with very limited packages installed.
Common data science packages such as `numpy`, `pandas`, or `scikit-learn` are not available.
The `serverless` framework helps us easily nail it by the `serverless-python-requirements` plugin.

To do so,
we need to install and maintain the `npm` package for our project:

```bash
npm init
npm install --save serverless-python-requirements
```

Or for the minimalist we can also simply run:

```bash
serverless plugin install -n serverless-python-requirements
```

This will generate a minimum `package.json` and also lock file,
along with the package installation,
in the meantime automatically update our `serverless.yml` for the `plugins` section.

Now the only thing left is to prepare a conventional `requirements.txt` file under our project that locks in the dependent Python packages.
The `serverless-python-requirements` package will automatically prepare the dependencies based on the requirement file.

## Implement the Function

Now let's edit the `handler.py` created in the boilerplate.

## Deploy

Now we are ready to deploy the service.
Simply run:

```bash
serverless deploy
```

## Smoke Test


```bash
serverless invoke local -f predict --data '{"body": "{\"year\": 2021, \"month\": 3}"}'
```

```bash
curl -H "Content-Type: application/json" --data '{"year": 2021, "month": 3}' https://<api-id>.execute-api.<region>.amazonaws.com/predict
```

## Destroy

To remove the entire deployment stack,
simply run:

```bash
serverless remove
```
